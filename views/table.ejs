<!-- views/index.ejs -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Excel Table</title>
        <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"
        ></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"
        ></script>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

        <style>
            body {
                font-family: 'Poppins', sans-serif;
            }
            table {
                border-collapse: collapse;
                width: 100%;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            th {
                background-color: #f2f2f2;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row">
                <h1 class="text-center">T·∫°o nhanh danh s√°ch ƒë∆°n no√†</h1>
            </div>

            <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="mb-3">
                <div class="mb-3">
                    <label for="file" class="form-label">Choose file</label>
                    <input type="file" class="form-control" id="file" name="file" />
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>

            <form id="createDS" action="/" method="post" enctype="multipart/form-data" class="mb-3">
                <div class="mb-3">
                    <label for="filename" class="form-label">Enter filename show in toastr</label>
                    <input type="text" class="form-control" id="filename" name="filename" />
                </div>
                <button type="submit" class="btn btn-primary">T·∫°o danh s√°ch no√†</button>
            </form>
        </div>
        <div id="DS" class="container">
            <!-- table -->
        </div>

        <footer class="container">
            <p class="text-end mt-5">2023 | Copyright from nguyenhuy158</p>
        </footer>

        <script>
            function createTable(data, dateSent, dateReceive, totalDon) {
                var table = $('<table>').addClass('text-center')

                // Add thead
                var thead = $('<thead>')
                var theadContent = `
                <tr>
                    <td colspan="6" class="text-start fw-bold">Tr∆∞·ªùng ƒê·∫°i h·ªçc T√¥n ƒê·ª©c Th·∫Øng</td>
                </tr>
                <tr>
                    <td colspan="6" class="text-start fw-bold">Ph√≤ng ƒê·∫°i h·ªçc</td>
                </tr>
                <tr>
                    <td colspan="6" class="text-center h3">DANH S√ÅCH B√ÄN GIAO ƒê∆†N</td>
                </tr>
                <tr>
                    <td colspan="6" class="text-start">Ng√†y nh·∫≠n: ${dateSent}</td>
                </tr>
                <tr>
                    <td colspan="6" class="text-start"></td>
                </tr>
                <tr>
                    <th class="text-center">STT</th>
                    <th class="text-center">S·ªë BN</th>
                    <th class="text-center">MSSV</th>
                    <th class="text-center">H·ªç v√† t√™n</th>
                    <th class="text-center">Ng∆∞·ªùi gi·∫£i quy·∫øt ƒë∆°n</th>
                    <th class="text-center">Ghi ch√∫</th>
                </tr>
            `
                thead.html(theadContent)
                table.append(thead)

                // Add tbody
                var tbody = $('<tbody>')

                // Add data rows
                $.each(data, function (index, row) {
                    console.log(`üöÄ üöÄ file: table.ejs:122 üöÄ row`, row);
                    console.log(`üöÄ üöÄ file: table.ejs:122 üöÄ index`, index);
                    var tr = $('<tr>')

                    if (Object.keys(row).length === 2) {
                        tr.html(`
                        <td class="text-center fw-bold" colspan="4">${row['Lo·∫°i ƒë∆°n (T√™n ƒë∆°n)']}</td>
                        <td class="text-center fw-bold">${row['Ng∆∞·ªùi gi·∫£i quy·∫øt ƒë∆°n']}</td>
                        <td class="text-center"></td>
                    `)
                    } else {
                        tr.html(`
                        <td class="text-center">${row['STT']}</td>
                        <td class="text-center">${row['S·ªë BN']}</td>
                        <td class="text-center">${row['MSSV']}</td>
                        <td class="text-center">${row['H·ªç v√† t√™n']}</td>
                        <td class="text-center">${row['Ng∆∞·ªùi gi·∫£i quy·∫øt ƒë∆°n']}</td>
                        <td class="text-center">${row['Ghi ch√∫'] || ''}</td>
                    `)
                    }

                    tbody.append(tr)
                })

                table.append(tbody)

                
                // Add tfoot
                var tfoot = $('<tfoot>')
                var tfootContent = `
                <tr>
                    <td colspan="6" class="text-start">T·ªïng ƒë∆°n: ${totalDon}</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="3" class="text-center">${dateReceive}</td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="3" class="text-center">Ng∆∞·ªùi l·∫≠p b·∫£ng</td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="3" class="text-center pt-5"></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="3" class="text-center">Nguy·ªÖn Duy Kh√°nh</td>
                    <td></td>
                </tr>
            `
                tfoot.html(tfootContent)
                table.append(tfoot)

                $('#DS').html(table)
            }
        </script>

        <script>
            toastr.options = {
                closeButton: true,
                debug: false,
                newestOnTop: false,
                progressBar: true,
                positionClass: 'toast-top-right',
                preventDuplicates: false,
                onclick: null,
                showDuration: '1000',
                hideDuration: '10000',
                timeOut: '5000',
                extendedTimeOut: '1000',
                showEasing: 'swing',
                hideEasing: 'linear',
                showMethod: 'fadeIn',
                hideMethod: 'fadeOut',
            }

            $('#uploadForm').on('submit', function (e) {
                e.preventDefault()

                var formData = new FormData(this)

                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.error) {
                            toastr.error(data.message)
                        } else {
                            toastr.success(data.message)

                            $('#createDS input').val(data.filename)
                        }
                    },
                    error: function (error) {
                        toastr.error(error.responseJSON?.message)
                    },
                })
            })

            $('#createDS').on('submit', function (e) {
                e.preventDefault()

                $.ajax({
                    url: '/',
                    type: 'POST',
                    data: { filename: $('#filename').val() },
                    success: function (data) {
                        if (data.error) {
                            toastr.error(data.message)
                        } else {
                            toastr.success(data.message)
                            createTable(data.data, data.dateSent, data.dateReceive, data.totalDon)
                        }
                    },
                    error: function (error) {
                        toastr.error(error.responseJSON?.message)
                    },
                })
            })
        </script>
    </body>
</html>
